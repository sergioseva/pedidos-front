
<div *ngIf="pedido.finalizado" class="row" style="margin-bottom: 1rem;">
    <div class="w-100 text-center alert alert-info">
        <i class="fa fa-info-circle" style="margin-right: 0.375rem;"></i>
        Pedido Finalizado, no se pueden agregar mas items, pulse reiniciar
    </div>
</div>
<br *ngIf="!pedido.finalizado">

<!-- Items del Pedido — full width -->
<div class="card card-section-items" style="margin-bottom: 1rem;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="card-icon-header">
            <i class="fa fa-list"></i>
            <span>Items del Pedido</span>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span *ngIf="pedido.pedidoItems.length > 0" class="badge" style="background: #2563EB; color: #fff; font-size: 0.8rem; padding: 0.35rem 0.65rem;">
                {{pedido.pedidoItems.length}} items
            </span>
            <button class="btn btn-action-secondary btn-sm"
                    [disabled]="pedido.finalizado"
                    (click)="openItemModal(itemModal)">
                <i class="fa fa-pencil" style="margin-right: 0.25rem;"></i> Agregar Manual
            </button>
            <button *ngIf="!pedido.finalizado"
                    class="btn btn-action btn-sm"
                    [disabled]="pedido.pedidoItems.length <= 0"
                    (click)="openDetalleModal(detalleModal)">
                <i class="fa fa-check-circle" style="margin-right: 0.25rem;"></i> Finalizar Pedido
            </button>
            <button *ngIf="pedido.finalizado"
                    class="btn btn-action btn-sm"
                    (click)="openDetalleModal(detalleModal)">
                <i class="fa fa-search" style="margin-right: 0.25rem;"></i> Revisar / Imprimir
            </button>
            <button class="btn btn-action-secondary btn-sm" (click)="onReiniciar()">
                <i class="fa fa-refresh" style="margin-right: 0.25rem;"></i> Reiniciar
            </button>
        </div>
    </div>
    <div class="card-body" style="padding: 1rem;">
        <div style="overflow-x: auto;">
            <table class="table" style="margin-bottom: 0;">
                <thead>
                    <tr>
                        <th scope="col" style="min-width: 180px;">Titulo</th>
                        <th scope="col" style="min-width: 100px;">Autor</th>
                        <th scope="col" style="min-width: 100px;">Editorial</th>
                        <th scope="col" style="min-width: 70px;">Precio</th>
                        <th scope="col" style="min-width: 70px;">Cantidad</th>
                        <th scope="col" style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let pedidoItem of pedido.pedidoItems">
                        <td>{{pedidoItem.libro}}</td>
                        <td>{{pedidoItem.autor}}</td>
                        <td>{{pedidoItem.editorial}}</td>
                        <td>$ {{pedidoItem.precio | number:'1.0-0':'es-AR'}}</td>
                        <td>{{pedidoItem.cantidad}}</td>
                        <td>
                            <div class="table-actions">
                                <button title="Eliminar" (click)="borrarItem(pedidoItem,i)" type="button" class="btn btn-icon btn-icon-danger">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div *ngIf="pedido.pedidoItems.length > 0"
             style="display: flex; justify-content: flex-end; padding: 0.75rem 0.5rem 0; border-top: 2px solid #C8BFB2;">
            <div class="summary-box" style="min-width: 160px; text-align: center;">
                Subtotal $ {{pedido.total | number:'1.0-0':'es-AR'}}
            </div>
        </div>
        <div *ngIf="pedido.pedidoItems.length === 0" style="text-align: center; padding: 2rem 1rem; color: #8C7A6A;">
            <i class="fa fa-shopping-cart" style="font-size: 2rem; margin-bottom: 0.5rem; display: block; opacity: 0.4;"></i>
            Agregue items desde la seccion Libros
        </div>
    </div>
</div>

<!-- Detalle del Pedido Modal -->
<ng-template #detalleModal>
    <div class="modal-header" style="background: #EDE9FE; border-bottom: 2px solid #8B5CF6;">
        <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
            <i class="fa fa-file-text-o" style="color: #7C3AED;"></i> Detalle del Pedido
        </h5>
        <button type="button" class="close" (click)="closeModal()">
            <span>&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <form [formGroup]="forma">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="clienteSelect">Seleccione el cliente</label>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <div id="clienteSelect" style="flex: 1;">
                                <ng-select [items]="clientes"
                                    [disableControl]="pedido.finalizado"
                                    formControlName="cliente"
                                    [(ngModel)]="clienteSeleccionado">
                                </ng-select>
                            </div>
                            <button *ngIf="!pedido.finalizado"
                                    class="btn btn-icon"
                                    title="Nuevo Cliente"
                                    type="button"
                                    (click)="toggleNuevoCliente()"
                                    style="margin-top: 1px;">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Seña</label>
                        <input type="number"
                            [disableControl]="pedido.finalizado"
                            class="form-control"
                            placeholder="Seña"
                            formControlName="senia"
                            [ngClass]="{ 'is-invalid': (forma.controls['senia'].invalid && forma.controls['senia'].touched) || seniaExceedsTotal }">
                        <div *ngIf="seniaExceedsTotal" class="small text-error">
                            La seña no puede superar el total ($ {{pedido.total}}).
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="summary-box">
                            Total $ {{pedido.total}}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Inline New Client Form -->
            <div *ngIf="showNuevoCliente" style="border: 1.5px solid var(--primary); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background: #FEF3C7;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: 600; color: var(--text);">
                    <i class="fa fa-user-plus"></i> Nuevo Cliente
                </div>
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Nombre <span class="text-error">*</span></label>
                        <input type="text" class="form-control" placeholder="Nombre del cliente"
                            [(ngModel)]="nuevoCliente.nombre" [ngModelOptions]="{standalone: true}">
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Celular <span class="text-error">*</span></label>
                        <input type="text" class="form-control" placeholder="Ej: 3446123456"
                            [(ngModel)]="nuevoCliente.telefonoMovil" [ngModelOptions]="{standalone: true}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Email</label>
                        <input type="text" class="form-control" placeholder="Email"
                            [(ngModel)]="nuevoCliente.email" [ngModelOptions]="{standalone: true}">
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Dirección</label>
                        <input type="text" class="form-control" placeholder="Dirección"
                            [(ngModel)]="nuevoCliente.direccion" [ngModelOptions]="{standalone: true}">
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn btn-action-secondary btn-sm" type="button" (click)="toggleNuevoCliente()">
                        <i class="fa fa-times" style="margin-right: 0.25rem;"></i> Cancelar
                    </button>
                    <button class="btn btn-action btn-sm" type="button"
                            [disabled]="!nuevoCliente.nombre || !nuevoCliente.telefonoMovil"
                            (click)="guardarNuevoCliente()">
                        <i class="fa fa-save" style="margin-right: 0.25rem;"></i> Guardar Cliente
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Observaciones</label>
                <textarea class="form-control"
                    [disableControl]="pedido.finalizado"
                    placeholder="Observaciones"
                    rows="2"
                    formControlName="observaciones"></textarea>
            </div>
        </form>
    </div>
    <div class="modal-footer" style="display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-action-secondary" (click)="closeModal()">
            <i class="fa fa-times" style="margin-right: 0.25rem;"></i> Cerrar
        </button>
        <button *ngIf="!pedido.finalizado"
                [disabled]="!forma.valid || pedido.pedidoItems.length<=0 || seniaExceedsTotal"
                class="btn btn-action" (click)="onSubmit()">
            <i class="fa fa-save" style="margin-right: 0.25rem;"></i> Guardar Pedido
        </button>
        <button *ngIf="pedido.finalizado"
                class="btn btn-action" (click)="onImprimir()">
            <i class="fa fa-print" style="margin-right: 0.25rem;"></i> Imprimir
        </button>
    </div>
</ng-template>

<!-- Agregar Item Manual Modal -->
<ng-template #itemModal>
    <div class="modal-header" style="background: #DBEAFE; border-bottom: 2px solid #2563EB;">
        <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
            <i class="fa fa-pencil" style="color: #1D4ED8;"></i> Agregar Item Manual
        </h5>
        <button type="button" class="close" (click)="closeItemModal()">
            <span>&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <app-pedido-item (itemAdded)="onItemAdded()"></app-pedido-item>
    </div>
</ng-template>
